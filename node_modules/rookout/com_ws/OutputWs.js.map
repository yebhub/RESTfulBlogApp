{"version":3,"sources":["../../../src/com_ws/OutputWs.js"],"names":["config","require","messages_pb","timestamp_pb","LOG_LEVELS","LogMessage","LogLevel","DEBUG","INFO","WARNING","ERROR","FATAL","OutputWs","constructor","id","_agentCom","_ruleStatusUpdatesBucket","TokenBucket","OutputWsConfiguration","MAX_STATUS_UPDATES","BUCKET_REFRESH_RATE","logger","error","_userMessageBucket","MAX_AUG_MESSAGES","_logMessageBucket","MAX_LOG_ITEMS","_internalSendLogMessage","__filename","registerOutput","setAgentCom","agentCom","flushMessages","callback","msgsFlushedPromise","then","catch","sendRuleStatus","ruleId","active","doIfAvailable","ruleStatusMessage","RuleStatusMessage","setAgentId","setRuleId","setActive","setError","dumps","addMessage","sendUserMessage","augId","messageId","args","msg","AugReportMessage","setAugId","setReportId","namespaceSerializer","NamespaceSerializer","DumpConfig","STRING_CACHE_USERMESSAGE","setArguments","stringCacheMap","getStringsCacheMap","stringCache","getStringCache","Object","keys","forEach","key","set","areUserMessagesFull","isExhausted","isQueueFull","sendLogMessage","level","time","filename","lineno","text","formattedMessage","date","Timestamp","fromDate","Date","setTimestamp","logLevel","undefined","setLevel","setFilename","setLine","setText","setFormattedMessage","setLegacyArguments","add","sendWarning","message","RookError"],"mappings":"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","sourcesContent":["import NamespaceSerializer from \"../processor/NamespaceSerializer\";\nimport {logger} from \"../logger\";\nimport TokenBucket from \"./TokenBucket\";\nimport RookError from \"../processor/RookError\";\nconst config = require(\"../config\");\n\nconst messages_pb = require(\"../protobuf/messages_pb\");\nconst timestamp_pb = require(\"google-protobuf/google/protobuf/timestamp_pb\");\n\n// Maps logger.js:LOG_LEVELS to the LogMessage enum\nconst LOG_LEVELS = {\n    0: messages_pb.LogMessage.LogLevel.DEBUG,\n    1: messages_pb.LogMessage.LogLevel.INFO,\n    2: messages_pb.LogMessage.LogLevel.WARNING,\n    3: messages_pb.LogMessage.LogLevel.ERROR,\n    4: messages_pb.LogMessage.LogLevel.FATAL\n};\n\nexport default class OutputWs {\n    constructor(id) {\n        this.id = id;\n        this._agentCom = null;\n\n        this._ruleStatusUpdatesBucket = new TokenBucket(\n            config.OutputWsConfiguration.MAX_STATUS_UPDATES,\n            config.OutputWsConfiguration.BUCKET_REFRESH_RATE,\n            () => logger.error(\"Limit reached, dropping status updates\"));\n\n        this._userMessageBucket = new TokenBucket(\n            config.OutputWsConfiguration.MAX_AUG_MESSAGES,\n            config.OutputWsConfiguration.BUCKET_REFRESH_RATE,\n            () => logger.error(\"Limit reached, dropping aug report messages\"));\n\n        this._logMessageBucket = new TokenBucket(\n            config.OutputWsConfiguration.MAX_LOG_ITEMS,\n            config.OutputWsConfiguration.BUCKET_REFRESH_RATE,\n            () => this._internalSendLogMessage(\n                3,\n                __filename,\n                0,\n                \"Limit reached, dropping log messages\",\n                \"Limit reached, dropping log messages\"));\n\n        logger.registerOutput(this);\n    }\n\n    setAgentCom(agentCom) {\n        this._agentCom = agentCom;\n    }\n\n    flushMessages(callback) {\n        let msgsFlushedPromise = this._agentCom.flushMessages();\n        msgsFlushedPromise.then(callback).catch(callback);\n    }\n\n    sendRuleStatus(ruleId, active, error) {\n        if (!this._agentCom) {\n            return;\n        }\n\n        this._ruleStatusUpdatesBucket.doIfAvailable(() => {\n            let ruleStatusMessage = new messages_pb.RuleStatusMessage();\n            ruleStatusMessage.setAgentId(this.id);\n            ruleStatusMessage.setRuleId(ruleId);\n            ruleStatusMessage.setActive(active);\n\n            if (error) {\n                ruleStatusMessage.setError(error.dumps());\n            }\n\n            this.addMessage(ruleId, ruleStatusMessage);\n        });\n    }\n\n    sendUserMessage(augId, messageId, args) {\n        if (!this._agentCom) {\n            return;\n        }\n\n        this._userMessageBucket.doIfAvailable(() => {\n            let msg = new messages_pb.AugReportMessage();\n            msg.setAgentId(this.id);\n            msg.setAugId(augId);\n            msg.setReportId(messageId);\n\n            if (args) {\n                let namespaceSerializer = new NamespaceSerializer(config.DumpConfig.STRING_CACHE_USERMESSAGE);\n                msg.setArguments(namespaceSerializer.dumps(args));\n\n                let stringCacheMap = msg.getStringsCacheMap();\n\n                let stringCache = namespaceSerializer.getStringCache();\n                Object.keys(stringCache).forEach((key) => {\n                    stringCacheMap.set(key, stringCache[key]);\n                });\n            }\n\n            this.addMessage(augId, msg);\n        });\n    }\n\n    areUserMessagesFull() {\n        return this._userMessageBucket.isExhausted() || (this._agentCom && this._agentCom.isQueueFull());\n    }\n\n    sendLogMessage(level, time, filename, lineno, text, formattedMessage, args) {\n        if (!this._agentCom) {\n            return;\n        }\n\n        this._logMessageBucket.doIfAvailable(() =>\n            this._internalSendLogMessage(level, filename, lineno, text, formattedMessage, args)\n        );\n    }\n\n    _internalSendLogMessage(level, filename, lineno, text, formattedMessage, args) {\n        if (!this._agentCom) {\n            return;\n        }\n\n        let msg = new messages_pb.LogMessage();\n\n        let date = new timestamp_pb.Timestamp();\n        date.fromDate(new Date());\n        msg.setTimestamp(date);\n\n        let logLevel = LOG_LEVELS[level];\n        if (logLevel === undefined) {\n            logLevel = messages_pb.LogMessage.LogLevel.WARNING;\n        }\n\n        msg.setAgentId(this.id);\n        msg.setLevel(logLevel);\n        msg.setFilename(filename);\n        msg.setLine(lineno);\n        msg.setText(text);\n        msg.setFormattedMessage(formattedMessage);\n        if (args) {\n            msg.setLegacyArguments(new NamespaceSerializer().dumps(args));\n        }\n\n        // DO NOT CHANGE TO 'addMessage' TO AVOID RECURSION LOOP\n        this._agentCom.add(msg);\n    }\n\n    sendWarning(ruleId, error) {\n        this.sendRuleStatus(ruleId, \"Warning\", error);\n    }\n\n    addMessage(ruleId, message) {\n        const error = this._agentCom.add(message);\n        if (error) {\n            this.sendWarning(ruleId, new RookError(error));\n        }\n    }\n}\n"],"file":"OutputWs.js"}