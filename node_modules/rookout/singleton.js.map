{"version":3,"sources":["../../src/singleton.js"],"names":["uuid4","require","Output","default","Singleton","constructor","id","replace","output","servicesStarted","triggerServices","augManager","agentCom","close","logger","info","stopServices","flush","callback","flushMessages","startServices","TriggerServices","AugManager","triggerSvc","notifyLambdaActive","context","notifyLambdaInactive","connect","token","host","port","proxy","tags","labels","debug","throw_errors","AgentCom","commandHandler","CommandHandler","setAgentCom","waitForReady","singleton"],"mappings":"AAAA;;;;;;;AAIA;;AAEA;;AAGA;;AACA;;;;AARA,MAAMA,KAAK,GAAGC,OAAO,CAAC,SAAD,CAArB;;AAMA,MAAMC,MAAM,GAAGD,OAAO,CAAC,mBAAD,CAAP,CAA6BE,OAA5C;;AAIA,MAAMC,SAAN,CAAgB;AACZC,EAAAA,WAAW,GAAG;AACV,SAAKC,EAAL,GAAUN,KAAK,GAAGO,OAAR,CAAgB,KAAhB,EAAuB,EAAvB,CAAV;AACA,SAAKC,MAAL,GAAc,IAAIN,MAAJ,CAAW,KAAKI,EAAhB,CAAd;AAEA,SAAKG,eAAL,GAAuB,KAAvB;AACA,SAAKC,eAAL,GAAuB,IAAvB;AACA,SAAKC,UAAL,GAAkB,IAAlB;AAEA,SAAKC,QAAL,GAAgB,IAAhB;AACH;;AAEU,QAALC,KAAK,GAAG;AACVC,mBAAOC,IAAP,CAAY,eAAZ;;AAEA,UAAMH,QAAQ,GAAG,KAAKA,QAAtB;AACA,SAAKA,QAAL,GAAgB,IAAhB;;AACA,QAAI,SAASA,QAAb,EAAuB;AACnB,YAAMA,QAAQ,CAACC,KAAT,EAAN;AACH;;AAED,UAAM,KAAKG,YAAL,EAAN;AACH;;AAEDC,EAAAA,KAAK,CAACC,QAAD,EAAW;AACZ,SAAKV,MAAL,CAAYW,aAAZ,CAA0BD,QAA1B;AACH;;AAEDE,EAAAA,aAAa,GAAG;AACZ,QAAI,KAAKX,eAAT,EAA0B;AACtB;AACH;;AAED,SAAKC,eAAL,GAAuB,IAAIW,wBAAJ,EAAvB;AACA,SAAKV,UAAL,GAAkB,IAAIW,mBAAJ,CAAe,KAAKZ,eAApB,EAAqC,KAAKF,MAA1C,CAAlB;AACA,SAAKC,eAAL,GAAuB,IAAvB;AACH;;AAEiB,QAAZO,YAAY,GAAG;AACjB,QAAI,CAAC,KAAKP,eAAV,EAA2B;AACvB;AACH;;AAED,SAAKE,UAAL,GAAkB,IAAlB;AAEA,UAAMY,UAAU,GAAG,KAAKb,eAAxB;AACA,SAAKA,eAAL,GAAuB,IAAvB;AACA,UAAMa,UAAU,CAACV,KAAX,EAAN;AAEA,SAAKJ,eAAL,GAAuB,KAAvB;AACH;;AAEDe,EAAAA,kBAAkB,CAACC,OAAD,EAAU;AACxB,QAAI,SAAS,KAAKb,QAAlB,EAA4B;AACxB,WAAKA,QAAL,CAAcY,kBAAd,CAAiCC,OAAjC;AACH;AACJ;;AAEDC,EAAAA,oBAAoB,GAAG;AACnB,QAAI,SAAS,KAAKd,QAAlB,EAA4B;AACxB,WAAKA,QAAL,CAAcc,oBAAd;AACH;AACJ;;AAEDC,EAAAA,OAAO,CAACC,KAAD,EAAQC,IAAR,EAAcC,IAAd,EAAoBC,KAApB,EAA2BC,IAA3B,EAAiCC,MAAjC,EAAyCC,KAAzC,EAAgDC,YAAhD,EAA8D;AACjE,SAAKf,aAAL;;AAEAN,mBAAOoB,KAAP,CAAa,6BAAb,EAA4CL,IAA5C,EAAkDC,IAAlD;;AACA,UAAMM,QAAQ,GAAGnC,OAAO,CAAC,qBAAD,CAAP,CAA+BE,OAAhD;;AACA,SAAKS,QAAL,GAAgB,IAAIwB,QAAJ,CAAa,KAAK9B,EAAlB,EAAsBuB,IAAtB,EAA4BC,IAA5B,EAAkCC,KAAlC,EAAyCH,KAAzC,EAAgDK,MAAhD,EAAwDD,IAAxD,EAA8DE,KAA9D,EAAqE,CAACC,YAAtE,CAAhB;AACA,SAAKE,cAAL,GAAsB,IAAIC,uBAAJ,CAAmB,KAAK1B,QAAxB,EAAkC,KAAKD,UAAvC,CAAtB;AACA,SAAKH,MAAL,CAAY+B,WAAZ,CAAwB,KAAK3B,QAA7B;AAEA,SAAKA,QAAL,CAAce,OAAd;AACA,WAAO,KAAKf,QAAL,CAAc4B,YAAd,EAAP;AACH;;AA3EW;;AA8ET,IAAIC,SAAS,GAAG,IAAIrC,SAAJ,EAAhB","sourcesContent":["\"use strict\";\r\n\r\nconst uuid4 = require(\"uuid/v4\");\r\n\r\nimport CommandHandler from \"./com_ws/CommandHandler\";\r\n\r\nimport {logger} from \"./logger\";\r\n\r\nconst Output = require(\"./com_ws/OutputWs\").default;\r\nimport TriggerServices from \"./TriggerServices\";\r\nimport AugManager from \"./augs/AugManager\";\r\n\r\nclass Singleton {\r\n    constructor() {\r\n        this.id = uuid4().replace(/\\-/g, \"\");\r\n        this.output = new Output(this.id);\r\n\r\n        this.servicesStarted = false;\r\n        this.triggerServices = null;\r\n        this.augManager = null;\r\n\r\n        this.agentCom = null;\r\n    }\r\n\r\n    async close() {\r\n        logger.info(\"Shutting down\");\r\n\r\n        const agentCom = this.agentCom;\r\n        this.agentCom = null;\r\n        if (null !== agentCom) {\r\n            await agentCom.close()\r\n        }\r\n\r\n        await this.stopServices();\r\n    }\r\n\r\n    flush(callback) {\r\n        this.output.flushMessages(callback);\r\n    }\r\n\r\n    startServices() {\r\n        if (this.servicesStarted) {\r\n            return;\r\n        }\r\n\r\n        this.triggerServices = new TriggerServices();\r\n        this.augManager = new AugManager(this.triggerServices, this.output);\r\n        this.servicesStarted = true;\r\n    }\r\n\r\n    async stopServices() {\r\n        if (!this.servicesStarted) {\r\n            return;\r\n        }\r\n\r\n        this.augManager = null;\r\n\r\n        const triggerSvc = this.triggerServices;\r\n        this.triggerServices = null;\r\n        await triggerSvc.close();\r\n\r\n        this.servicesStarted = false;\r\n    }\r\n\r\n    notifyLambdaActive(context) {\r\n        if (null !== this.agentCom) {\r\n            this.agentCom.notifyLambdaActive(context);\r\n        }\r\n    }\r\n\r\n    notifyLambdaInactive() {\r\n        if (null !== this.agentCom) {\r\n            this.agentCom.notifyLambdaInactive();\r\n        }\r\n    }\r\n\r\n    connect(token, host, port, proxy, tags, labels, debug, throw_errors) {\r\n        this.startServices();\r\n\r\n        logger.debug(\"Initiating AgentCom-\\t%s:%d\", host, port);\r\n        const AgentCom = require(\"./com_ws/AgentComWs\").default;\r\n        this.agentCom = new AgentCom(this.id, host, port, proxy, token, labels, tags, debug, !throw_errors);\r\n        this.commandHandler = new CommandHandler(this.agentCom, this.augManager);\r\n        this.output.setAgentCom(this.agentCom);\r\n\r\n        this.agentCom.connect();\r\n        return this.agentCom.waitForReady();\r\n    }\r\n}\r\n\r\nexport let singleton = new Singleton();\r\n"],"file":"singleton.js"}